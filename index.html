<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Acesso</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
        video, img { max-width: 100%; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table, th, td { border: 1px solid #ccc; }
        th, td { padding: 8px; text-align: center; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 4px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 6px; }
        button { padding: 10px 15px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h2>Registro de Acesso</h2>

    <!-- C칙mera -->
    <video id="video" autoplay></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <img id="photoPreview" style="margin-top:10px; max-width:300px; border-radius:8px; display:none;" />
    <br>
    <button type="button" onclick="takePhoto()">游닞 Capturar Foto</button>

    <!-- Formul치rio -->
    <form id="accessForm">
        <div class="form-group">
            <label for="document">Documento (CPF ou outro)</label>
            <input type="text" id="document" required>
        </div>
        <div class="form-group">
            <label for="fullName">Nome Completo</label>
            <input type="text" id="fullName" required>
        </div>
        <div class="form-group">
            <label for="visitorType">Tipo de Visitante</label>
            <select id="visitorType" required>
                <option value="">Selecione</option>
                <option value="Visitante">Visitante</option>
                <option value="Prestador de Servi칞o">Prestador de Servi칞o</option>
                <option value="Morador">Morador</option>
            </select>
        </div>
        <div class="form-group">
            <label for="destination">Destino</label>
            <input type="text" id="destination">
        </div>
        <div class="form-group">
            <label for="observation">Observa칞칚o</label>
            <textarea id="observation"></textarea>
        </div>
        <div class="form-group">
            <label for="vehicleModel">Modelo do Ve칤culo</label>
            <input type="text" id="vehicleModel">
        </div>
        <div class="form-group">
            <label for="vehiclePlate">Placa do Ve칤culo</label>
            <input type="text" id="vehiclePlate">
        </div>
        <div class="form-group">
            <label for="vehicleColor">Cor do Ve칤culo</label>
            <input type="text" id="vehicleColor">
        </div>
        <div class="form-group">
            <label for="company">Empresa</label>
            <input type="text" id="company">
        </div>
        <button type="submit">Salvar Registro</button>
    </form>

    <!-- Tabela -->
    <table id="accessTable">
        <thead>
            <tr>
                <th>Foto</th>
                <th>Documento</th>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Destino</th>
                <th>Data/Hora</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
let accessData = [];
let capturedPhoto = "";

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const photoPreview = document.getElementById('photoPreview');

// Acessa a c칙mera
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => { video.srcObject = stream; })
    .catch(err => { alert("Erro ao acessar a c칙mera: " + err.message); });

// Capturar foto e mostrar na tela
function takePhoto() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    capturedPhoto = canvas.toDataURL('image/png');
    photoPreview.src = capturedPhoto;
    photoPreview.style.display = 'block';
}

// Valida칞칚o de CPF
function validarCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g, '');
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;

    let soma = 0, resto;
    for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i - 1, i)) * (11 - i);
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(9, 10))) return false;

    soma = 0;
    for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i - 1, i)) * (12 - i);
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(10, 11))) return false;

    return true;
}

// Salvar dados no localStorage
function saveData() {
    localStorage.setItem('accessData', JSON.stringify(accessData));
}

// Adicionar na tabela
function addToTable(entry) {
    const tbody = document.querySelector('#accessTable tbody');
    const row = tbody.insertRow();
    row.innerHTML = `
        <td><img src="${entry.photo}" width="60"></td>
        <td>${entry.document}</td>
        <td>${entry.fullName}</td>
        <td>${entry.visitorType}</td>
        <td>${entry.destination}</td>
        <td>${entry.dateTime}</td>
    `;
}

// Evento de envio do formul치rio
document.getElementById('accessForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const documento = document.getElementById('document').value.trim();
    if (!capturedPhoto) {
        alert("Por favor, capture uma foto antes de registrar!");
        return;
    }

    const isCPF = /^\d{3}\.?\d{3}\.?\d{3}-?\d{2}$/.test(documento) || /^\d{11}$/.test(documento);
    if (isCPF && !validarCPF(documento)) {
        alert("CPF inv치lido! Verifique e tente novamente.");
        return;
    }

    const now = new Date();
    const dateTime = now.toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });

    const entry = {
        photo: capturedPhoto,
        document: documento,
        fullName: document.getElementById('fullName').value,
        visitorType: document.getElementById('visitorType').value,
        destination: document.getElementById('destination').value,
        observation: document.getElementById('observation').value,
        vehicleModel: document.getElementById('vehicleModel').value,
        vehiclePlate: document.getElementById('vehiclePlate').value,
        vehicleColor: document.getElementById('vehicleColor').value,
        company: document.getElementById('company').value,
        dateTime: dateTime
    };

    accessData.push(entry);
    saveData();
    addToTable(entry);
    this.reset();
    capturedPhoto = "";
    photoPreview.style.display = 'none';
    alert("Registro salvo com sucesso!");
});
</script>

</body>
</html>

